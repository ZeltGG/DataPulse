<h1>Dashboard</h1>

<p *ngIf="loading">Cargando...</p>
<p *ngIf="error" class="error">{{ error }}</p>

<div *ngIf="resumen" class="kpis">
  <mat-card>
    <h3>Paises</h3>
    <p>{{ resumen.kpis.total_paises }}</p>
  </mat-card>
  <mat-card>
    <h3>Alertas activas</h3>
    <p>{{ resumen.kpis.alertas_activas }}</p>
  </mat-card>
  <mat-card>
    <h3>Mis portafolios</h3>
    <p>{{ resumen.kpis.portafolios_usuario }}</p>
  </mat-card>
  <mat-card>
    <h3>Promedio IRPC</h3>
    <p>{{ resumen.kpis.promedio_irpc }}</p>
  </mat-card>
</div>

<mat-card style="margin-bottom: 16px;">
  <h2>Mapa de Riesgo Latam</h2>
  <div id="latam-map" class="map"></div>
  <p *ngIf="!mapa.length">No hay datos de riesgo para mostrar en el mapa.</p>
</mat-card>

<mat-card style="margin-bottom: 16px;">
  <h2>Ranking IRPC</h2>
  <canvas id="riesgo-chart"></canvas>
  <p *ngIf="!resumen?.ranking?.length">No hay ranking disponible.</p>
</mat-card>

<mat-card style="margin-bottom: 16px;">
  <h2>Tendencias (ultimos 5 anos)</h2>
  <div class="trend-filters">
    <label>
      Indicador
      <select [(ngModel)]="tipoSeleccionado" (ngModelChange)="loadTendencias()">
        <option *ngFor="let tipo of tiposIndicador" [value]="tipo">{{ tipo }}</option>
      </select>
    </label>
    <p class="filters-help">
      Maximo 3 paises activos. Si agregas un cuarto, se reemplaza automaticamente el mas antiguo.
    </p>
    <div class="checkboxes">
      <label
        *ngFor="let iso of paisesDisponibles"
        [class.selected]="paisesSeleccionados.includes(iso)"
        [style.--chip-color]="countryColor(iso)"
      >
        <input
          type="checkbox"
          [checked]="paisesSeleccionados.includes(iso)"
          (change)="onPaisToggle(iso, $any($event.target).checked)"
        />
        {{ iso }}
      </label>
    </div>
  </div>
  <canvas id="tendencias-chart"></canvas>
  <p *ngIf="!tendencias?.series?.length">No hay series disponibles para esta combinacion.</p>
</mat-card>

<table *ngIf="resumen" class="table">
  <thead>
    <tr>
      <th>Pais</th>
      <th>IRPC</th>
      <th>Nivel</th>
      <th>Variacion</th>
      <th>Tendencia</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let row of resumen.ranking">
      <td>
        <span class="country-dot" [style.background]="countryColor(row.pais__codigo_iso)"></span>
        {{ row.pais__nombre }} ({{ row.pais__codigo_iso }})
      </td>
      <td>{{ row.indice_compuesto }}</td>
      <td>{{ row.nivel_riesgo }}</td>
      <td>{{ row.variacion }}</td>
      <td>{{ row.tendencia }}</td>
    </tr>
  </tbody>
</table>

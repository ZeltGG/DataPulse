<a routerLink="/portafolios">Volver</a>

<p *ngIf="loading">Cargando...</p>
<p *ngIf="error" class="error">{{ error }}</p>

<div *ngIf="!loading && !error && item" class="card">
  <h1>{{ item.nombre }}</h1>
  <p class="desc">{{ item.descripcion || 'Sin descripcion' }}</p>

  <div class="actions">
    <button *ngIf="canWrite" type="button" (click)="editPortafolio()">Editar portafolio</button>
    <button type="button" (click)="exportPdf()">Exportar PDF</button>
  </div>

  <div *ngIf="canWrite" class="actions">
    <a [routerLink]="['/portafolios', item.id, 'posiciones', 'new']">+ Crear posicion</a>
  </div>

  <div class="metrics" *ngIf="resumen">
    <div><strong>Monto total:</strong> {{ resumen.monto_total }}</div>
    <div><strong>Riesgo promedio:</strong> {{ resumen.riesgo_promedio }}</div>
  </div>

  <div class="charts" *ngIf="resumen">
    <div>
      <h3>Distribucion por pais</h3>
      <canvas id="dist-pais-chart"></canvas>
    </div>
    <div>
      <h3>Distribucion por tipo activo</h3>
      <canvas id="dist-tipo-chart"></canvas>
    </div>
  </div>

  <hr />

  <h2>Posiciones</h2>

  <table *ngIf="item.posiciones?.length" class="table">
    <thead>
      <tr>
        <th>Activo</th>
        <th>Ticker</th>
        <th>Pais</th>
        <th>Tipo</th>
        <th>Moneda</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Peso %</th>
        <th *ngIf="canWrite">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let posicion of item.posiciones">
        <td>{{ posicion.activo }}</td>
        <td>{{ posicion.ticker || '-' }}</td>
        <td>{{ posicion.pais }}</td>
        <td>{{ posicion.tipo_activo }}</td>
        <td>{{ posicion.moneda }}</td>
        <td>{{ posicion.cantidad }}</td>
        <td>{{ posicion.precio_unitario }}</td>
        <td>{{ posicion.peso_porcentual ?? '-' }}</td>
        <td *ngIf="canWrite">
          <button
            type="button"
            (click)="editPosicion(posicion.id)"
            [disabled]="editingPosicionId === posicion.id || deletingPosicionId === posicion.id"
          >
            {{ editingPosicionId === posicion.id ? 'Guardando...' : 'Editar' }}
          </button>
          <button
            type="button"
            (click)="deletePosicion(posicion.id)"
            [disabled]="deletingPosicionId === posicion.id || editingPosicionId === posicion.id"
          >
            {{ deletingPosicionId === posicion.id ? 'Cerrando...' : 'Cerrar' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <p *ngIf="!item.posiciones?.length">No hay posiciones en este portafolio.</p>
</div>
